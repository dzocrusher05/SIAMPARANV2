// app_map.js â€” langkah 1: peta minimal + marker cluster\n(function(){\n  const API = window.API_BASE || '../api';\n  const UI = {\n    btnFilter: null, btnLegend: null, btnLocate: null, btnFollow: null,\n    ovFilter: null, ovLegend: null,\n    q: null, qSuggest: null, selKab: null, selKec: null, selKel: null, selJenis: null,\n    legendBody: null\n  };\n  const filter = { q:'', kab:'', kec:'', kel:'', jenis:[] };\n  let watchId = null;\n  let meMarker = null; let meAccCircle = null;\n  // Objek untuk menyimpan data sarana yang dimuat, diakses dengan ID\n  const loadedSarana = {};\n\n  // Cache untuk icon jenis sarana\n  const jenisIconCache = {};\n\n  // Peta jenis -> warna + glyph (nama harus sama dengan di DB)\n  const JENIS_META = {\n    'Lainnya':                                  {color:'#e5e7eb', glyph:'dot', icon: 'lainnya.png'},\n    'Sarana Distribusi Kosmetik':               {color:'#fde68a', glyph:'sparkles', icon: 'cosmetic.png'},\n    'Sarana Distribusi Obat Bahan Alam':        {color:'#bbf7d0', glyph:'leaf', icon: 'herbal.png'},\n    'Sarana Distribusi Obat IFK':               {color:'#fda4af', glyph:'warehouse', icon: 'medicine.png'},\n    'Sarana Distribusi Pangan':                 {color:'#c7d2fe', glyph:'truck', icon: 'shopping-basket.png'},\n    'Sarana Pelayanan Kefarmasian Rumah Sakit': {color:'#bae6fd', char:'hospital', icon: 'hospital.png'},\n    'Sarana Distribusi Obat PBF':               {color:'#fecaca', glyph:'box', icon: 'pharmacyindus.png'},\n    'Sarana Distribusi Suplemen Kesehatan':     {color:'#ddd6fe', glyph:'pill', icon: 'dietary-suplement.png'},\n    'Sarana Lain-Lain Toko Obat':               {color:'#fde68a', glyph:'bag', icon: 'tokoobat.png'},\n    'Sarana Pelayanan Kefarmasian Apotek':      {color:'#a5f3fc', glyph:'bowl', icon: 'pharmacy.png'},\n    'Sarana Pelayanan Kefarmasian Klinik':      {color:'#d9f99d', glyph:'cross', icon: 'clinic.png'},\n    'Sarana Pelayanan Kefarmasian Puskesmas':   {color:'#99f6e4', glyph:'clinic', icon: 'puskesmas.png'},\n    'Sarana Produksi Fortifikasi':              {color:'#e9d5ff', glyph:'beaker'},\n    'Sarana Produksi PIRT':                     {color:'#fed7aa', glyph:'home', icon: 'pirt.png'},\n    'Sarana Produksi Pangan Olahan':            {color:'#bfdbfe', glyph:'factory', icon: 'md.png'},\n    'Sarana Produksi Sediaan Farmasi':          {color:'#fecaca', glyph:'flask'}\n  };\n\n  function escapeHtml(s){\n    return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;').replaceAll(\"'\",'&#039;');\n  }\n\n  function glyphSVG(name){\n    const stroke=\"#111827\", sw=1.5, fill=\"none\";\n    switch(name){\n      case 'truck': return `<path d=\"M2 13h9V7H2v6Zm9 0h4l2.5-3H11v3Z\" fill=\"${stroke}\" stroke=\"${stroke}\" stroke-width=\"${sw}\" /><circle cx=\"6.5\" cy=\"17\" r=\"1.5\" fill=\"${stroke}\"/><circle cx=\"14.5\" cy=\"17\" r=\"1.5\" fill=\"${stroke}\"/>`;\n      case 'pill': return `<rect x=\"6\" y=\"6\" width=\"12\" height=\"12\" rx=\"6\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/><path d=\"M7.5 13.5l9-9\" stroke=\"${stroke}\" stroke-width=\"${sw}\" />`;\n      case 'leaf': return `<path d=\"M12 5c-4 0-7 3-7 7 0 3 2.5 5.5 5.5 5.5C14 17 17 14 18 10c1.5-3 2.5-4 4-5-3 .5-5-.5-10 0Z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'sparkles': return `<path d=\"M12 5l1.5 3.5L17 10l-3.5 1.5L12 15l-1.5-3.5L7 10l3.5-1.5L12 5Z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'box': return `<path d=\"M4 8l8-4 8 4-8 4-8-4Z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/><path d=\"M12 12v8m8-12v8l-8 4-8-4V8\" stroke=\"${stroke}\" stroke-width=\"${sw}\"/>`;\n      case 'warehouse': return `<path d=\"M3 10l9-4 9 4v8H3v-8Z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/><path d=\"M7 12h4v6H7zM13 12h4v6h-4z\" stroke=\"${stroke}\" stroke-width=\"${sw}\"/>`;\n      case 'cross': return `<path d=\"M10 5h4v4h4v4h-4v4h-4v-4H6v-4h4V5z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'hospital': return `<rect x=\"6\" y=\"6\" width=\"12\" height=\"12\" rx=\"2.5\" fill=\"${fill}\" stroke=\"${stroke}\" stroke-width=\"${sw}\"/><path d=\"M12 8v8M8 12h8\" stroke=\"${stroke}\" stroke-width=\"${sw}\"/>`;\n      case 'bowl': return `<path d=\"M5 10h14a7 7 0 01-14 0Z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'clinic': return `<path d=\"M6 18V8h12v10H6z M12 6v4m-2-2h4\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'bag': return `<path d=\"M7 8h10v10H7z M9 8a3 3 0 016 0\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'factory': return `<path d=\"M4 18h16v2H4z M6 16V9l4 3V9l4 3V8h4v8\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'beaker': return `<path d=\"M8 5h8v2l-3 5v4H11v-4L8 7z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'home': return `<path d=\"M5 11l7-6 7 6v8H5v-8z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      case 'flask': return `<path d=\"M10 5h4v6l3 5H7l3-5V5z\" stroke=\"${stroke}\" stroke-width=\"${sw}\" fill=\"${fill}\"/>`;\n      default: return `<circle cx=\"12\" cy=\"12\" r=\"4\" fill=\"${stroke}\" />`;\n    }\n  }\n\n  // Fungsi untuk membuat icon marker\n  function makeIcon(kind, nameLabel){\n    const meta = JENIS_META[kind] || JENIS_META['Lainnya'];\n    let iconHtml;\n\n    // Cek apakah ada icon khusus di cache\n    if (jenisIconCache[kind] && jenisIconCache[kind].icon_base64) {\n      iconHtml = `<img src=\"data:image/png;base64,${jenisIconCache[kind].icon_base64}\" style=\"width:32px; height:32px;\">`;\n    } \n    // Jika tidak, cek apakah ada icon file statis\n    else if (meta.icon) {\n      iconHtml = `<img src=\"/assets/icon/${meta.icon}\" style=\"width:24px; height:24px;\">`;\n    } \n    // Jika tidak ada, gunakan SVG default\n    else {\n      const bg = meta.color || '#e5e7eb';\n      iconHtml = `<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n        <path d=\"M12 2c-3.86 0-7 3.14-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z\" fill=\"${bg}\" stroke=\"#11182722\"/>\n        <circle cx=\"12\" cy=\"9\" r=\"4.2\" fill=\"#ffffff\"/>\n        <g transform=\"translate(12,9) scale(0.55) translate(-12,-12)\">\n          ${glyphSVG(meta.glyph)}\n        </g>\n      </svg>`;\n    }\n\n    const html = `<div style=\"text-align: center;\">\n                    ${iconHtml}\n                    <div style=\"font-size: 12px; color: #000; white-space: nowrap; margin-top: 2px; background: rgba(255, 255, 255, 0.7); padding: 2px 5px; border-radius: 3px; box-shadow: 0 0 2px #fff;\">${escapeHtml(nameLabel)}</div>\n                  </div>`;\n\n    return L.divIcon({\n      className: 'custom-div-icon',\n      html: html,\n      iconSize: [80, 40],\n      iconAnchor: [40, 40],\n      popupAnchor: [0, -40]\n    });\n  }\n\n  // Fungsi untuk memuat icon jenis sarana\n  async function loadJenisIcons() {\n    try {\n      const response = await fetch(`${API}/jenis.php`);\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const jenisData = await response.json();\n      \n      // Simpan icon ke cache\n      jenisData.forEach(jenis => {\n        if (jenis.icon_base64) {\n          jenisIconCache[jenis.nama_jenis] = {\n            icon_base64: jenis.icon_base64,\n            has_custom_icon: jenis.has_custom_icon\n          };\n        }\n      });\n      \n      console.log('Jenis icons loaded:', Object.keys(jenisIconCache).length);\n    } catch (error) {\n      console.error('Error loading jenis icons:', error);\n    }\n  }\n\n  // Fungsi untuk memuat data sarana\n  async function fetchSarana(limit, bbox){\n    try {\n      const qs = new URLSearchParams();\n      if (limit) qs.set('limit', String(limit)); else qs.set('limit','5000');\n      if (bbox) qs.set('bbox', bbox);\n      if (filter.q) qs.set('q', filter.q);\n      if (filter.kab) qs.set('kabupaten', filter.kab);\n      if (filter.kec) qs.set('kecamatan', filter.kec);\n      if (filter.kel) qs.set('kelurahan', filter.kel);\n      if (filter.jenis?.length) qs.set('jenis', filter.jenis.join(','));\n      \n      const url = `${API}/sarana.php?${qs.toString()}`;\n      console.log('Fetching data from URL:', url);\n      \n      const res = await fetch(url);\n      console.log('Response status:', res.status);\n      \n      if (!res.ok) throw new Error(`HTTP ${res.status}`);\n      \n      const data = await res.json();\n      console.log('Data received:', data);\n      \n      return data;\n    } catch (err) {\n      console.error('Error fetching sarana data:', err);\n      throw err;\n    }\n  }